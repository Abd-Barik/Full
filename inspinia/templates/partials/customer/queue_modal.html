
    <style>
        .modal-dialog {
            max-width: 600px;
        }

        .section-title {
            font-weight: 600;
            font-size: 1rem;
            color: #0d6efd;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin: 20px 0 15px 0;
        }

        .outstanding-amount {
            color: #d32f2f;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .user-avatar {
            width: 120px;
            height: 150px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;

        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar .placeholder-icon {
            font-size: 2.5rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .outstanding-container {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .modal-body {
            max-height: 70vh; /* 可视窗口高度的 70% */
            overflow-y: auto; /* 超过时允许纵向滚动 */
            overflow-x: hidden; /* 禁止横向滚动，保持布局整洁 */
            padding-right: 10px; /* 给滚动条留点空间 */
        }
    </style>


<!-- Registration Modal -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <!-- Header -->
            <div class="modal-header">
                <h5 class="modal-title">Registration Dialog</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Form -->
            <form method="post" id="registrationForm">
                <div class="modal-body">
                    
                    <div class="section-title">Registration Information</div>
                    
                    <div class="row">
                        <!-- Left side form fields -->
                        <div class="col-md-9">
                            
                            <!-- Date and Doctor -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="visitdate" class="form-label">Date</label>
                                    <input type="datetime-local" name="visitdate" class="form-control" required data-provider="flatpickr" data-date-format="Y-m-d" data-enable-time>
                                </div>
                                <div class="col-md-6">
                                    <label for="doctor-select" class="form-label">Doctor</label>
                                    <select name="doctor_rno" id="doctor-select" class="form-select" required>
                                        <option value="">Select Doctor</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Title and Name -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="registrationtitle" class="form-label">Title</label>
                                    <input type="text" id="registrationtitle" name="title" class="form-control" required disabled>
                                </div>
                                <div class="col-md-9">
                                    <label for="registrationname" class="form-label">Name</label>
                                    <input type="text" id="registrationname" name="name" class="form-control" required disabled>
                                </div>
                            </div>

                            

                        </div>

                                        <!-- Right side avatar -->
                        <div class="col-md-3">
                            <div class="user-avatar" id="userAvatar">
                                <i class="fas fa-user placeholder-icon"></i>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <!-- Complaints -->
                            <div class="mb-3">
                                <label for="complaints" class="form-label">Complaints</label>
                                <textarea name="complaints" id="complaints" class="form-control" rows="3"></textarea>
                            </div>

                            <!-- Customer Remark -->
                            <div class="mb-3">
                                <label for="remark" class="form-label">Customer Remark</label>
                                <textarea name="remark" id="remark" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Assistant Consultant and Working Shift -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="assist_consultant" class="form-label">Assistant Consultant</label>
                            <select name="assist_consultant" id="assist_consultant" class="form-select">
                                <option value="">Select Assistant</option>
                                <option value="1">Nurse Jane</option>
                                <option value="2">Nurse Mary</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="shift" class="form-label">Working Shift</label>
                            <select name="shift" id="shift" class="form-select">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                    </div>

                    <!-- Registered by and Room -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="registered_by" class="form-label">Registered by</label>
                            <input type="text" name="registered_by" id="registered_by" class="form-control" disabled value="soonhong">
                        </div>
                        <div class="col-md-6">
                            <label for="room" class="form-label">Room</label>
                            <select name="room" id="room" class="form-select">
                                <option value="">Select Room</option>
                                <option value="1">Room 1</option>
                                <option value="2">Room 2</option>
                            </select>
                        </div>
                    </div>

                    <!-- Queue Numbers -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="last_q_no" class="form-label">Last "Q" No.</label>
                            <input type="number" name="last_q_no" id="last_q_no" class="form-control" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="queuno" class="form-label">Next "Q" No.</label>
                            <input type="number" name="queuno" id="queuno" class="form-control" readonly>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="empty_q_no" class="form-check-input" id="emptyQ">
                                <label class="form-check-label" for="emptyQ">Empty "Q" No.</label>
                            </div>
                        </div>
                    </div>

                    <!-- Ticket and Chit Numbers -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ticketno" class="form-label">Ticket No.</label>
                            <input type="text" name="ticketno" id="ticketno" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="chitno" class="form-label">Chit No.</label>
                            <input type="text" name="chitno" id="chitno" class="form-control">
                        </div>
                    </div>

                    <!-- Billing Type -->
                    <div class="mb-3">
                        <label for="billtype_rno" class="form-label">Billing Type</label>
                        <select name="billtype_rno" id="billtype_rno" class="form-select">
                            <option value="1" selected>CASH PATIENT</option>
                            <option value="2">BILL TO COMPANY</option>
                            <option value="3">BILL TO FAMILY COMPANY</option>
                        </select>
                    </div>

                    
                    <div class="mb-3">
                        <label for="panelcompany_rno" class="form-label">Panel Company</label>
                        <div class="input-group">
                            
                            <span class="input-group-text p-0">
                                <input type="text" name="panelcompany_rno" id="panelcompany_rno"
                                    class="form-control border-0 text-center" style="width: 80px;" readonly>
                            </span>

                        
                            <input type="text" name="panelcompany_name" id="panelcompany_name"
                                class="form-control" placeholder="Enter Panel Company">

                      
                            <button type="button" class="btn btn-outline-secondary" id="panelcompany_search">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>



                    <!-- Membership and Reference -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="membershipno" class="form-label">Membership #</label>
                            <input type="text" name="membershipno" id="membershipno" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="reference" class="form-label">Reference</label>
                            <input type="text" name="reference" id="reference" class="form-control">
                        </div>
                    </div>

                    <div class="section-title">Registration Options</div>
                    
                    <div class="checkbox-group mb-4">
                        <div class="form-check">
                            <input type="checkbox" name="buying_product_medicine" class="form-check-input" id="buying">
                            <label class="form-check-label" for="buying">Buying Product / Medicine</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="ismedicalcheckup" class="form-check-input" id="checkup">
                            <label class="form-check-label" for="checkup">Medical Checkup</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="isconsultation" class="form-check-input" id="consultation" checked>
                            <label class="form-check-label" for="consultation">Consultation</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="virtual_consult" class="form-check-input" id="virtual">
                            <label class="form-check-label" for="virtual">Virtual Consult</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="isappointment" class="form-check-input" id="appointment">
                            <label class="form-check-label" for="appointment">Appointment</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="isforeigner" class="form-check-input" id="foreigner">
                            <label class="form-check-label" for="foreigner">Foreigner</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="emergency_case" class="form-check-input" id="emergency">
                            <label class="form-check-label" for="emergency">Emergency Case</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="section-title">Visit Type</div>
                            <div class="radio-group">
                                <div class="form-check">
                                    <input type="radio" name="visit_type" value="outpatient" class="form-check-input" id="outpatient" checked>
                                    <label class="form-check-label" for="outpatient">Outpatient</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" name="visit_type" value="inpatient" class="form-check-input" id="inpatient">
                                    <label class="form-check-label" for="inpatient">Inpatient</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" name="visit_type" value="others" class="form-check-input" id="others">
                                    <label class="form-check-label" for="others">Others</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="outstanding-container">
                                <label class="form-label">Outstanding Amount</label>
                                <div class="outstanding-amount">RM 1,000.00</div>
                                <input type="hidden" name="outstanding" value="0.00">
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="customer_rno" id="hiddenCustomerRno">

                </div> <!-- modal-body end -->

                <!-- Footer Buttons -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Register</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include "partials/customer/panelcompany_dialog.html" %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
// 模拟设置用户头像的函数
function setUserAvatar(imageUrl) {
    const avatarElement = document.getElementById('userAvatar');
    if (imageUrl) {
        avatarElement.innerHTML = `<img src="${imageUrl}" alt="User Avatar" >`;
    } else {
        avatarElement.innerHTML = '<i class="fas fa-user placeholder-icon"></i>';
    }
}


function onCustomerChange(customer_rno) {
    // 更新隐藏字段
    const hiddenCustomerRno = document.getElementById('hiddenCustomerRno');
    if (hiddenCustomerRno) {
        hiddenCustomerRno.value = customer_rno;
    }
    
    // 加载panel company信息
    if (customer_rno) {
        setUserpanelcompany(customer_rno);
    }
}

/////

///
document.addEventListener("DOMContentLoaded", function () {
    let now = new Date();
    let year = now.getFullYear();
    let month = String(now.getMonth() + 1).padStart(2, '0');
    let day = String(now.getDate()).padStart(2, '0');
    let hours = String(now.getHours()).padStart(2, '0');
    let minutes = String(now.getMinutes()).padStart(2, '0');

    // 拼接成本地时间格式
    let localDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;
    let today = `${year}-${month}-${day}`;
    


    fetch(`/api/queue/next-number/?start_date=${today}&end_date=${today}`)
        .then(response => response.json())
        .then(data => {
            let lastQInput = document.querySelector('input[name="last_q_no"]');
            let nextQInput = document.querySelector('input[name="queuno"]');

            let lastQ = data.latest_queuno || 0; // 如果没有数据则为 0
            lastQInput.defaultValue = lastQ;
            nextQInput.defaultValue = lastQ + 1; // 下一号为上一个加一
        })
        .catch(error => console.error('Error:', error));

    fetch('/api/queue/doctor-select/')
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById('doctor-select');
            select.innerHTML = ''; // 清空原有选项
            data.doctors.forEach(d => {
                let option = document.createElement('option');
                option.value = d.doctor_rno;
                option.textContent = d.doctorname;
                select.appendChild(option);
            });
        })
        .catch(err => console.error('Doctor list loading error:', err));

    // 表单提交处理
    const registrationForm = document.getElementById('registrationForm');
    
    registrationForm.addEventListener('submit', function(e) {
        e.preventDefault(); // 阻止默认表单提交
        
        // 显示提交按钮加载状态
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // 收集表单数据
        const formData = new FormData(this);
        
        // 处理复选框数据 - 确保未选中的复选框也有值
        const checkboxes = this.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                formData.set(checkbox.name, 'false');
            } else {
                formData.set(checkbox.name, 'true');
            }
        });
        
        // 处理单选按钮
        const visitType = this.querySelector('input[name="visit_type"]:checked');
        if (visitType) {
            formData.set('visit_type', visitType.value);
        }
        
        // 转换FormData为JSON对象（可选，如果后端期望JSON格式）
        const jsonData = {};
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
        
        
        // 发送POST请求
        fetch('/api/registration/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(), // CSRF token处理
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Registration successful:', data);
            
            if (data.success) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('registrationModal'));
    modal.hide();
    
    // 切换标签页、播放音效并刷新表格
    switchTabAndRefresh('main');
    
    registrationForm.reset();
}else {
                // 处理业务逻辑错误
                alert('Registration failed: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Registration error:', error);
            alert('An error occurred while submitting registration. Please try again.');
        })
        .finally(() => {
            // 恢复提交按钮状态
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });

    
});

</script>

