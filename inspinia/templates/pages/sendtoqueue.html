{% extends 'layouts/vertical.html' %}

{% load static i18n %}

{% block title %}Customer Management{% endblock title %}

{% block extra_css %}
    <style>
 .user-avatar {
            width: 120px;
            height: 150px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;

        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .outstanding-container {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .outstanding-amount {
            color: #d32f2f;
            font-weight: bold;
            font-size: 0.9rem;
        }
    </style>
{% endblock extra_css %}

{% block page_content %}
    <div class="container-fluid">
        <div class="row mt-3">
            <div class="col-12">
                <form id="registrationForm">
                    {% csrf_token %}
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                   

                    <div class="row g-3">
                        <!-- Registration Information Card - Left Column -->
                        <div class="col-lg-12">
                            <div class="card " style="max-height: 70vh; overflow-y: auto;">
                                <div class="card-header p-2">
                                    <h5 class="card-title mb-0">Registration Information</h5>
                                    <small class="text-muted">Please provide registration details for the patient visit.</small>
                                </div>

                                <div class="card-body p-3">
                                    
                                    <!-- Basic Info Row -->
                                    <div class="row">
                                        <input type="hidden" name="customer_rno" id="hiddenCustomerRno" value="{% if data.0.customer_rno %}{{ data.0.customer_rno }}{% endif %}">
                                        
                                        <!-- 左侧字段区域 -->
                                        <div class="col-md-10">
                                            <!-- Date and Doctor Row -->
                                            <div class="row g-2 mb-2">
                                                <div class="col-3">
                                                    <label for="visitdate" class="form-label small">Date: <span class="text-danger">*</span></label>
                                                    <input type="datetime-local" name="visitdate" class="form-control form-control-sm" id="visitdate" required>

                                                </div>
                                                <div class="col-9">
                                                    <label for="doctor-select" class="form-label small">Doctor: <span class="text-danger">*</span></label>
                                                    <select name="doctor_rno" id="doctor-select" class="form-select form-select-sm" required>
                                                        <option value="">Select Doctor</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- Title and Name Row -->
                                            <div class="row g-2">
                                                <div class="col-3">
                                                    <label for="registrationtitle" class="form-label small">Title:</label>
                                                    <input type="text" id="registrationtitle" name="title" class="form-control form-control-sm" value="{% if data.0.title %}{{ data.0.title }}{% endif %}" readonly>
                                                </div>
                                                <div class="col-9">
                                                    <label for="registrationname" class="form-label small">Name: <span class="text-danger">*</span></label>
                                                    <input type="text" id="registrationname" name="name" class="form-control form-control-sm" required value="{% if data.0.name %}{{ data.0.name }}{% endif %}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 用户头像 -->
                                        <div class="col-md-2">
                                            <div class="d-flex justify-content-center align-items-center h-100">
                                                <div class="user-avatar" id="userAvatar">
                                                    {% if data.0.photo %}
                                                        <img src="data:image/jpeg;base64,{{ data.0.photo }}" alt="User Avatar">
                                                    {% else %}
                                                        <i class="fas fa-user placeholder-icon"></i>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Complaints and Remarks Row -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <label for="complaints" class="form-label small">Complaints:</label>
                                            <textarea name="complaints" class="form-control form-control-sm" rows="4" placeholder="Enter patient complaints"></textarea>
                                        </div>
                                        <div class="col-6">
                                            <label for="remark" class="form-label small">Customer Remark:</label>
                                            <textarea name="remark" class="form-control form-control-sm" rows="4" placeholder="Enter customer remarks"></textarea>
                                        </div>
                                    </div>

                                    <!-- Staff and Room Row -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-3">
                                            <label for="assist_consultant" class="form-label small">Assist. Consultant:</label>
                                            <select name="assist_consultant" class="form-select form-select-sm">
                                                <option value="">Select Consultant</option>
                                                <option value="1">Nurse Jane</option>
                                                <option value="2">Nurse Mary</option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <label for="shift" class="form-label small">Working Shift:</label>
                                            <select name="shift" class="form-select form-select-sm">
                                                <option value="1">Shift 1</option>
                                                <option value="2">Shift 2</option>
                                                <option value="3">Shift 3</option>
                                                <option value="4">Shift 4</option>
                                            </select>
                                        </div>
                                        <div class="col-3">
                                            <label for="registered_by" class="form-label small">Registered by:</label>
                                            <input type="text" name="registered_by" class="form-control form-control-sm" disabled value="soonhong">
                                        </div>
                                        <div class="col-3">
                                            <label for="room" class="form-label small">Room:</label>
                                            <select name="room" class="form-select form-select-sm">
                                                <option value="">Select Room</option>
                                                <option value="1">Room 1</option>
                                                <option value="2">Room 2</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Queue Numbers Row -->
                                    <div class="row g-2 mb-2">
                                        <div class="col-3">
                                            <label for="last_q_no" class="form-label small">Last "Q" No.:</label>
                                            <input type="number" name="last_q_no" class="form-control form-control-sm" readonly>
                                        </div>
                                        <div class="col-3">
                                            <label for="queuno" class="form-label small">Next "Q" No.:</label>
                                            <input type="number" name="queuno" class="form-control form-control-sm" readonly>
                                        </div>
                                        <div class="col-2">
                                            <label class="form-label small">&nbsp;</label>
                                            <div class="form-check">
                                                <input type="checkbox" name="empty_q_no" class="form-check-input" id="emptyQ">
                                                <label class="form-check-label small" for="emptyQ">Empty "Q" No.</label>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <label for="ticketno" class="form-label small">Ticket No.:</label>
                                            <input type="text" name="ticketno" class="form-control form-control-sm">
                                        </div>
                                        <div class="col-2">
                                            <label for="chitno" class="form-label small">Chit No.:</label>
                                            <input type="text" name="chitno" class="form-control form-control-sm">
                                        </div>
                                    </div>

                                    
                                </div>
                            
                                <div class="card-header p-2">
                                    <h5 class="card-title mb-0">Billing Information & Registration Options</h5>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Billing Information Section -->
                                    <div class="row g-2 mb-3">
                                        <div class="col-12">
                                            <label for="billtype_rno" class="form-label small">Billing Type:</label>
                                            <select name="billtype_rno" class="form-select form-select-sm "id="billtype_rno">
                                                <option value="1" selected>CASH PATIENT</option>
                                                <option value="2">BILL TO COMPANY</option>
                                                <option value="3">BILL TO FAMILY COMPANY</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-2 mb-3">
                                        <div class="col-12">
                                            <label for="panelcompany_search" class="form-label small">Panel Company:</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" name="panelcompany_rno" id="panelcompany_rno"
                                                    class="form-control" style="max-width: 100px;" readonly 
                                                    value="{% if data.0.panelcomp_rno %}{{ data.0.panelcomp_rno }}{% endif %}">
                                                <input type="text" name="panelcompany_name" id="panelcompany_name"
                                                    class="form-control" placeholder="Search company..."
                                                    value="{% if data.0.pcompanyname %}{{ data.0.pcompanyname }}{% endif %}">
                                                <button type="button" class="btn btn-outline-secondary" id="panelcompany_search">
                                                    <i data-lucide="search"></i>
                                                </button>
                                            </div>

                                        </div>
                                    </div>

                                    
                                    <div class="row g-2 mb-3">
                                        <div class="col-6">
                                            <label for="membershipno" class="form-label small">Membership #:</label>
                                            <input type="text" name="membershipno" class="form-control form-control-sm">
                                        </div>
                                        <div class="col-6">
                                            <label for="reference" class="form-label small">Reference:</label>
                                            <input type="text" name="reference" class="form-control form-control-sm">
                                        </div>
                                        
                                    </div>

                                    <!-- Divider -->
                                    <hr class="my-3">

                                    <!-- Registration Options Section -->
                                    <div class="mb-3">
                                        <h6 class="mb-2">Registration Options</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="buying_product_medicine" class="form-check-input" id="buying">
                                                    <label class="form-check-label small" for="buying">Buying Product / Medicine</label>
                                                </div>
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="ismedicalcheckup" class="form-check-input" id="checkup">
                                                    <label class="form-check-label small" for="checkup">Medical Checkup</label>
                                                </div>
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="isconsultation" class="form-check-input" id="consultation" checked>
                                                    <label class="form-check-label small" for="consultation">Consultation</label>
                                                </div>
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="virtual_consult" class="form-check-input" id="virtual">
                                                    <label class="form-check-label small" for="virtual">Virtual Consult</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="isappointment" class="form-check-input" id="appointment">
                                                    <label class="form-check-label small" for="appointment">Appointment</label>
                                                </div>
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="isforeigner" class="form-check-input" id="foreigner">
                                                    <label class="form-check-label small" for="foreigner">Foreigner</label>
                                                </div>
                                                <div class="form-check form-check-sm">
                                                    <input type="checkbox" name="emergency_case" class="form-check-input" id="emergency">
                                                    <label class="form-check-label small" for="emergency">Emergency Case</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Visit Type Section -->
                                    <div class="mb-0">
                                        <h6 class="mb-2">Visit Type</h6>
                                        <div class="d-flex gap-4">
                                            <div class="form-check form-check-sm">
                                                <input type="radio" name="visit_type" value="outpatient" class="form-check-input" id="outpatient" checked>
                                                <label class="form-check-label small" for="outpatient">Outpatient</label>
                                            </div>
                                            <div class="form-check form-check-sm">
                                                <input type="radio" name="visit_type" value="inpatient" class="form-check-input" id="inpatient">
                                                <label class="form-check-label small" for="inpatient">Inpatient</label>
                                            </div>
                                            <div class="form-check form-check-sm">
                                                <input type="radio" name="visit_type" value="others" class="form-check-input" id="others">
                                                <label class="form-check-label small" for="others">Others</label>
                                            </div>
                                        </div>
                                        
                                    </div>
                                    

                                    <div class="mt-auto text-end">
                                        <label class="form-label small">Outstanding:</label>
                                        <div class="outstanding-amount fw-bold">1000.00</div>
                                        <input type="hidden" name="outstanding" value="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Action Buttons -->
                <div class="mt-3 d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i data-lucide="arrow-left" class="fs-sm me-2"></i> Back
                    </button>
                    <button type="button" class="btn btn-success" id="saveRegistration">
                        <i data-lucide="user-plus" class="fs-sm me-2"></i> Register
                    </button>
                    <div id="loadingSpinner" class="spinner-border text-success d-none" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include "partials/customer/panelcompany_dialog.html" %}
{% endblock page_content %}

{% block extra_javascript %}
<script src="{% static 'js/pages/panelcompany.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}



document.addEventListener("DOMContentLoaded", function () {
    let now = new Date();
    let year = now.getFullYear();
    let month = String(now.getMonth() + 1).padStart(2, '0');
    let day = String(now.getDate()).padStart(2, '0');
    let hours = String(now.getHours()).padStart(2, '0');
    let minutes = String(now.getMinutes()).padStart(2, '0');

    // 拼接成本地时间格式
    let localDatetime = `${year}-${month}-${day}T${hours}:${minutes}`;
    let today = `${year}-${month}-${day}`;
    
    // 设置默认时间
    document.getElementById('visitdate').value = localDatetime;

    // 加载队列号码信息
    fetch(`/api/queue/next-number/?start_date=${today}&end_date=${today}`)
        .then(response => response.json())
        .then(data => {
            let lastQInput = document.querySelector('input[name="last_q_no"]');
            let nextQInput = document.querySelector('input[name="queuno"]');

            let lastQ = data.latest_queuno || 0; // 如果没有数据则为 0
            lastQInput.value = lastQ;
            nextQInput.value = lastQ + 1; // 下一号为上一个加一
        })
        .catch(error => console.error('Error:', error));

    // 加载医生选择列表
    fetch('/api/queue/doctor-select/')
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById('doctor-select');
            select.innerHTML = '<option value="">Select Doctor</option>'; // 清空原有选项
            data.doctors.forEach(d => {
                let option = document.createElement('option');
                option.value = d.doctor_rno;
                option.textContent = d.doctorname;
                select.appendChild(option);
            });
        })
        .catch(err => console.error('Doctor list loading error:', err));

    // 加载账单类型选择列表
    fetch('/api/billtype/list/')
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById('billtype_rno');
            select.innerHTML = '<option value="">Select Billing Type</option>'; // 清空原有选项
            
            data.billtypes.forEach(bt => {
                let option = document.createElement('option');
                option.value = bt.billtype_rno;
                option.textContent = bt.billtype;
                
                // 如果当前客户有默认账单类型，设置为选中
                {% if data.0.billtype %}
                if (bt.billtype === '{{ data.0.billtype }}') {
                    option.selected = true;
                }
                {% endif %}
                
                select.appendChild(option);
            });
        })
        .catch(err => console.error('Billtype list loading error:', err));

    // 表单提交处理
    const registrationForm = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('saveRegistration');
    
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault(); // 阻止默认行为
        
        // 验证必填字段
        const requiredFields = registrationForm.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            alert('Please fill in all required fields');
            return;
        }
        
        // 显示提交按钮加载状态
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i data-lucide="loader" class="fs-sm me-2 animate-spin"></i> Submitting...';
        
        // 收集表单数据
        const formData = new FormData(registrationForm);
        
        // 处理复选框数据 - 确保未选中的复选框也有值
        const checkboxes = registrationForm.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                formData.set(checkbox.name, 'false');
            } else {
                formData.set(checkbox.name, 'true');
            }
        });
        
        // 处理单选按钮
        const visitType = registrationForm.querySelector('input[name="visit_type"]:checked');
        if (visitType) {
            formData.set('visit_type', visitType.value);
        }
        
        // 转换FormData为JSON对象
        const jsonData = {};
        for (let [key, value] of formData.entries()) {
            jsonData[key] = value;
        }
        
        console.log('Submitting data:', jsonData); // 调试用
        
        // 发送POST请求
        fetch('/api/registration/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(), // CSRF token处理
            },
            body: JSON.stringify(jsonData)
        })
        .then(response => {
            console.log('Response status:', response.status); // 调试用
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Registration successful:', data);
            
            if (data.success) {
            
                alert('Registration successful!');
               
                window.location.href = '/'; 
            } else {
   
                alert('Registration failed: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Registration error:', error);
            alert('An error occurred while submitting registration. Please try again.');
        })
        .finally(() => {
            // 恢复提交按钮状态
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
});
    </script>

{% endblock extra_javascript %}